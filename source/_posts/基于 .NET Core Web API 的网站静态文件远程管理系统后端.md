---
title: åŸºäº .NET Core Web API çš„ç½‘ç«™é™æ€æ–‡ä»¶è¿œç¨‹ç®¡ç†ç³»ç»Ÿåç«¯
tags: [ç¼–ç¨‹,æ•™ç¨‹,ç½‘ç«™,åç«¯,ç®¡ç†,.NET,C#]
date: 2025-10-05 23:59:00
updated: 2025-10-05 23:59:00
categories: [æŠ€æœ¯åˆ†äº«]
cover: https://img.afwlhx.top/i/2025/10/07/zofjgj.webp
main_color: "#71269C"
---

## å‰è¨€

ä¹‹å‰åšä¸»çš„åšå®¢æ˜¯åŸºäº Halo çš„ï¼Œä½†ç”±äº Halo æ˜¯åŸºäº Java ï¼Œå¯¹åšä¸»è¿™ç§åªä¹°å¾—èµ·é˜¿é‡Œäº‘ 2 æ ¸ 2G äº‘æœåŠ¡å™¨çš„è´«å›°å­¦ç”Ÿæ¥è¯´ï¼Œå‹åŠ›è¿˜æ˜¯å¤ªå¤§ã€‚

æ‰€ä»¥åšä¸»å°±å°† Halo çš„åšå®¢é‡æ„ä¸ºåŸºäº Hexo æ¡†æ¶çš„çº¯é™æ€åšå®¢ï¼Œè¿™æ ·é€Ÿåº¦å’ŒæœåŠ¡å™¨çš„å‹åŠ›éƒ½ä¼šæœ‰æ˜æ˜¾æ”¹å–„ã€‚

ä½†æ˜¯ç°åœ¨ç½‘ä¸Šæµä¼ æœ€å¤šçš„ Hexo è‡ªåŠ¨éƒ¨ç½²æ–¹æ¡ˆéƒ½æ˜¯åŸºäº Github Action çš„æ„å»ºæ–¹æ³•ï¼Œè€Œä¸”åŸºæœ¬ä¸Šéƒ¨ç½²çš„å¹³å°éƒ½æ˜¯ç½‘ç«™ç©ºé—´ï¼ˆVercelã€Netlify ç­‰ç½‘ç«™æ‰˜ç®¡å¹³å°ï¼‰ï¼Œè¿™å°±å¯¹äºæˆ‘ä»¬æœåŠ¡å™¨ç”¨æˆ·ä¸æ˜¯é‚£ä¹ˆçš„å‹å¥½ã€‚

åœ¨åšä¸»ç»å†è¿‡æ— æ•°æ¬¡ï¼š**æ‰“å¼€æœåŠ¡å™¨åå° --> ç™»å½• --> æ‰¾åˆ°ç½‘ç«™æ ¹ç›®å½• --> åˆ é™¤æ‰€æœ‰åŸæœ‰é™æ€æ–‡ä»¶ --> ä¸Šä¼ æ–°ç½‘ç«™çš„å‹ç¼©åŒ… --> è§£å‹ç¼© --> åˆ é™¤å‹ç¼©åŒ…** çš„æ“ä½œä¹‹åï¼Œæˆ‘è¿˜æ˜¯å¿ä¸ä½äº†ï¼Œå†³å®šå†™ä¸€ä¸ªä¸€é”®ä¸Šä¼ å‹ç¼©åŒ…ï¼Œè‡ªåŠ¨å®Œæˆç½‘ç«™æ›´æ–°çš„é¡¹ç›®ã€‚

æœ€åï¼Œè¯¥é¡¹ç›®ä¸ºç¼–ç¨‹å°ç™½é ç€è‡ªå·±çš„æƒ³æ³•å’Œ ChatGPT å®Œæˆï¼Œå¤§ä½¬å‹¿å–·ğŸ™ï¼Œé¡¹ç›®ä¹Ÿå°†æŒç»­å®Œå–„ã€‚

## é¡¹ç›®å‡†å¤‡

### æŠ€æœ¯åŸºç¡€

- C# è¯­è¨€ç¼–ç¨‹åŸºç¡€
- ASP .NET Core Web API åŸºç¡€äº†è§£

## é¡¹ç›®ç»“æ„

- ç½‘é¡µé™æ€æ–‡ä»¶ â¡ï¸ Web API â¡ï¸ Nginx åå‘ä»£ç† â¡ï¸ ç”¨æˆ·è®¿é—®
- ç»´æŠ¤æ¥å£ä¸Šä¼ é™æ€æ–‡ä»¶å‹ç¼©åŒ… â¡ï¸  Web API ï¼ˆè§£å‹ç¼©ï¼‰â¡ï¸ ç½‘é¡µé™æ€æ–‡ä»¶ï¼ˆåˆ é™¤ã€è¦†ç›–ï¼‰

## åˆ›å»º .NET Core Web API é¡¹ç›®

æ–‡ä»¶ç›®å½•ï¼š

```
MyApp/
â”œâ”€â”€ MyApp.sln
â”œâ”€â”€ MyApp/
â”‚   â”œâ”€â”€ Properties/
â”‚   â”‚   â””â”€â”€ LaunchSettings.json
â”‚   â”œâ”€â”€ wwwroot/
â”‚   â”‚   â”œâ”€â”€ index.html
â”‚   â”‚   â”œâ”€â”€ 404.html
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ js/
â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â””â”€â”€ UploadController.cs
â”‚ 	â”œâ”€â”€ appsettings.json
â”‚ 	â”œâ”€â”€ appsettings.Development.cs
â”‚ 	â”œâ”€â”€ Program.cs
â”‚   â””â”€â”€ ...
```

## å…è®¸é™æ€æ–‡ä»¶è®¿é—®

### åœ¨ Program.cs æ–‡ä»¶ä¸­ï¼š

åœ¨ `app.MapControllers();` ä¸Šæ–¹æ·»åŠ ï¼š

```c#
// è‡ªåŠ¨å¯»æ‰¾index.html
app.UseDefaultFiles();

// ä½¿ç”¨é™æ€èµ„æº
app.UseStaticFiles();
```

æ·»åŠ  `app.UseDefualtFiles();` åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯»æ‰¾è®¿é—®ç›®å½•çš„ index.html æ–‡ä»¶ï¼Œä¾‹å¦‚è®¿é—® https://localhost:5144/ ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å¯»æ‰¾ wwwroot ï¼ˆç½‘ç«™æ ¹ç›®å½•ï¼‰ä¸‹çš„ index.html æ–‡ä»¶ã€‚

æ·»åŠ  `app.UseStaticFiles();` åï¼Œç³»ç»Ÿä¼šå…è®¸è®¿é—® wwwroot é‡Œé¢çš„æ–‡ä»¶ã€‚

è‡³æ­¤ï¼ŒWeb API å°±å¯ä»¥å½“ä½œä¸€ä¸ªé™æ€æœåŠ¡å™¨ï¼ŒæŒ‚è½½é™æ€èµ„æºã€‚

## è§£å†³æœªçŸ¥é¡µé¢è‡ªåŠ¨è·³è½¬ 404.html

åœ¨ç»è¿‡ä¸Šè¿°æ­¥éª¤ä¹‹åï¼Œç½‘ç«™è™½ç„¶èƒ½å¤Ÿæ­£å¸¸è®¿é—®ï¼Œä½†è¿˜å­˜åœ¨ç€ä¸€äº›é—®é¢˜ã€‚å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢çš„æ—¶å€™ï¼Œç½‘ç«™å°±ä¼šç›´æ¥è¿”å› 404 çŠ¶æ€ç ï¼Œä¸ä¼šè·³è½¬åˆ°æˆ‘ä»¬é¢„å…ˆå‡†å¤‡å¥½çš„ 404.html æ–‡ä»¶ã€‚

è§£å†³æ–¹æ³•ï¼š

### åœ¨ Program.cs æ–‡ä»¶ä¸­ï¼š

åœ¨ `app.Run();` ä¸Šæ–¹æ·»åŠ ï¼š

```c#
// æ³¨æ„ï¼šä¸è¦ç”¨ MapFallbackToFileï¼
// æ”¹ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„ä¸­é—´ä»¶æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶
app.Use(async (context, next) =>
{
    await next(); // è®©è¯·æ±‚å…ˆç»è¿‡å‰é¢çš„ç®¡é“ï¼ˆåŒ…æ‹¬é™æ€æ–‡ä»¶ã€APIï¼‰

    // å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™è¿”å› 404.html
    if (context.Response.StatusCode == 404 && // çŠ¶æ€ç æ˜¯404
        !context.Request.Path.StartsWithSegments("/api") && // ä¸å¸¦ /api è·¯å¾„
        !Path.HasExtension(context.Request.Path.Value)) // ä¸å«æ‰©å±•å
    {
        context.Response.ContentType = "text/html";
        await context.Response.SendFileAsync(Path.Combine(app.Environment.WebRootPath, "404.html"));
    }
});
```

### è§£æâ€”â€”ä¸¤ç±»â€œ404â€è¯·æ±‚ï¼š

1. é¡µé¢è·¯å¾„ä¸å­˜åœ¨ï¼ˆæ— æ‰©å±•åï¼‰

   - ä¾‹å¦‚ /aboutã€/blog/123

   - å¯¹åº”çš„ä¸æ˜¯é™æ€æ–‡ä»¶ï¼Œè€Œæ˜¯å‰ç«¯è·¯ç”±æˆ–é¡µé¢

   - æˆ‘ä»¬å¸Œæœ›è¿”å› **è‡ªå®šä¹‰ 404.html**

   - å¤„ç†æ–¹å¼ï¼š

     ```c#
     if (!Path.HasExtension(...) && !StartsWithSegments("/api"))
     {
         è¿”å› 404.html
     }
     ```

2. é™æ€èµ„æºä¸å­˜åœ¨ï¼ˆæœ‰æ‰©å±•åï¼‰

   - ä¾‹å¦‚ /css/missing.cssã€/js/app.js
   - æµè§ˆå™¨è¯·æ±‚é™æ€æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé»˜è®¤ 404
   - å¦‚æœä½ è¿”å› 404.htmlï¼Œæµè§ˆå™¨ä¼šå°è¯•æŠŠ HTML å½“ä½œ CSS/JS åŠ è½½ â†’ å‡ºé”™
   - ä¸å¤„ç†ï¼Œè®©æµè§ˆå™¨è¿”å›åŸç”Ÿ 404 çŠ¶æ€ï¼Œæ›´å®‰å…¨

### ä¸ºä»€ä¹ˆä¸å¯¹é™æ€æ–‡ä»¶è¿”å› 404.html

å‡è®¾ç”¨æˆ·è®¿é—® /css/missing.cssï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿”å› 404.htmlï¼š

`<link rel="stylesheet" href="/css/missing.css">`

- æœåŠ¡å™¨è¿”å›çš„æ˜¯ HTML å†…å®¹ï¼ˆ404.htmlï¼‰
- æµè§ˆå™¨æŠŠ HTML å½“ä½œ CSS è§£æ â†’ æŠ¥é”™
- é¡µé¢å¸ƒå±€å¯èƒ½å…¨éƒ¨ä¹±æ‰

åŒç†ï¼Œç¼ºå¤± JSã€å›¾ç‰‡ã€å­—ä½“ä¹Ÿä¼šå‡ºé”™ã€‚

æ‰€ä»¥å®è·µä¸­ï¼Œ**é€šå¸¸åªå¯¹â€œé¡µé¢è¯·æ±‚â€è¿”å›è‡ªå®šä¹‰ 404.html**ï¼Œé™æ€æ–‡ä»¶ä»ä¿ç•™ 404 çŠ¶æ€ç ï¼Œè®©æµè§ˆå™¨çŸ¥é“èµ„æºä¸å­˜åœ¨ã€‚

## é€šè¿‡ API ä¸Šä¼ æ¥æ”¶ç½‘ç«™å‹ç¼©åŒ…

åœ¨ Controllers æ–‡ä»¶å¤¹ä¸­ï¼Œæ–°å»º UploadController.cs æ–‡ä»¶ã€‚

```c#
using System.IO.Compression;
using Microsoft.AspNetCore.Mvc;

namespace api_hexo_afwlhx.Controllers;

[ApiController]
[Route("api/[action]")]
public class UploadController : ControllerBase
{
    private readonly IWebHostEnvironment _env;

    public UploadController(IWebHostEnvironment env)
    {
        _env = env;
    }

    [HttpPost]
    public async Task<IActionResult> Upload(IFormFile file, string key)
    {
        if (key != "your_key") return BadRequest(new { message = "é”™è¯¯key!" });

        if (file == null || file.Length == 0)
            return BadRequest("æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶");

        // æ£€æŸ¥æ˜¯å¦æ˜¯ zip
        if (!file.FileName.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
            return BadRequest("è¯·ä¸Šä¼  zip æ–‡ä»¶");

        // ä¸´æ—¶è·¯å¾„
        var tempPath = Path.Combine(_env.ContentRootPath, "temp");
        Directory.CreateDirectory(tempPath);

        var zipPath = Path.Combine(tempPath, file.FileName);

        // ä¿å­˜ zip
        using (var stream = new FileStream(zipPath, FileMode.Create))
        {
            await file.CopyToAsync(stream);
        }

        // è§£å‹è·¯å¾„ï¼ˆwwwrootï¼‰
        var wwwrootPath = Path.Combine(_env.ContentRootPath, "wwwroot");

        // æ¸…ç©ºæ—§æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œè§†éœ€æ±‚ï¼‰
        foreach (var dir in Directory.GetDirectories(wwwrootPath))
            Directory.Delete(dir, true);
        foreach (var f in Directory.GetFiles(wwwrootPath))
            System.IO.File.Delete(f);

        // è§£å‹
        ZipFile.ExtractToDirectory(zipPath, wwwrootPath);

        // åˆ é™¤ zip
        System.IO.File.Delete(zipPath);

        return Ok(new { message = "ç½‘ç«™å·²æ›´æ–°æˆåŠŸ" });
    }
}
```

## å‰ç«¯è®¿é—®

è‡³æ­¤ï¼ŒAPI çš„æ­å»ºå·²å®Œæˆã€‚

**æ¥å£åœ°å€ï¼š/api/Uploadï¼ˆå¯é€šè¿‡ /swagger/index.html æŸ¥çœ‹æ¥å£åœ°å€å¹¶æµ‹è¯•æ¥å£ï¼‰ã€‚**
